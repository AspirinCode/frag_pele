


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>AdaptivePELE.clustering.clustering &mdash; AdaptivePELE  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="AdaptivePELE  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> AdaptivePELE
          

          
          </a>

          
            
            
              <div class="version">
                v1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../AdaptivePELE.html">AdaptivePELE Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Examples.html">AdaptivePELE Overview</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">AdaptivePELE</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          









<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
        <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>AdaptivePELE.clustering.clustering</li>
    <li class="wy-breadcrumbs-aside">
      
          
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for AdaptivePELE.clustering.clustering</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="c"># import cPickle as pickle</span>
<span class="kn">import</span> <span class="nn">clusteringTypes</span>
<span class="kn">import</span> <span class="nn">thresholdcalculator</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.constants</span> <span class="kn">import</span> <span class="n">blockNames</span>
<span class="kn">import</span> <span class="nn">AdaptivePELE.atomset.atomset</span> <span class="kn">as</span> <span class="nn">atomset</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.utilities</span> <span class="kn">import</span> <span class="n">utilities</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.atomset</span> <span class="kn">import</span> <span class="n">SymmetryContactMapEvaluator</span> <span class="k">as</span> <span class="n">sym</span>
<span class="kn">from</span> <span class="nn">AdaptivePELE.atomset</span> <span class="kn">import</span> <span class="n">RMSDCalculator</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="c"># if &quot;bsccv&quot; not in socket.gethostname():</span>
<span class="c">#     from sklearn.cluster import AffinityPropagation</span>
<span class="c">#     from sklearn.cluster import AgglomerativeClustering</span>
<span class="c">#     from sklearn.cluster import KMeans</span>


<div class="viewcode-block" id="Clusters"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clusters">[docs]</a><span class="k">class</span> <span class="nc">Clusters</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;clusters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>


    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;clusters&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Clusters.addCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clusters.addCluster">[docs]</a>    <span class="k">def</span> <span class="nf">addCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Clusters.insertCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clusters.insertCluster">[docs]</a>    <span class="k">def</span> <span class="nf">insertCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">cluster</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Insert a cluster in a specified index&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cluster</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Clusters.getNumberClusters"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clusters.getNumberClusters">[docs]</a>    <span class="k">def</span> <span class="nf">getNumberClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Clusters.getCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clusters.getCluster">[docs]</a>    <span class="k">def</span> <span class="nf">getCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusterNum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">clusterNum</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Clusters.printClusters"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clusters.printClusters">[docs]</a>    <span class="k">def</span> <span class="nf">printClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;--------------&quot;</span>
            <span class="k">print</span> <span class="s">&quot;CLUSTER #</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="k">print</span> <span class="s">&quot;--------------&quot;</span>
            <span class="n">cluster</span><span class="o">.</span><span class="n">printCluster</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;&quot;</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">clusters</span>

</div>
<div class="viewcode-block" id="AltStructures"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.AltStructures">[docs]</a><span class="k">class</span> <span class="nc">AltStructures</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper class, each cluster will have an instance of AltStructures that</span>
<span class="sd">        will maintain a priority queue (pq) of alternative structures to spawn</span>
<span class="sd">        from encoded as tuples (priority, PDB).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limitSize</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;altStructPQ&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">,</span> <span class="s">&quot;limitSize&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">limitSize</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limitSize</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;limitSize&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;altStructPQ&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="AltStructures.altSpawnSelection"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.AltStructures.altSpawnSelection">[docs]</a>    <span class="k">def</span> <span class="nf">altSpawnSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">centerPair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Select an alternative PDB from the cluster center to spawn from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subpopulations</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">]</span>
        <span class="n">totalSubpopulation</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subpopulations</span><span class="p">)</span>
        <span class="c"># Create a list of the population distributed between the cluster</span>
        <span class="c"># center and the alternative structures</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">centerPair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">totalSubpopulation</span><span class="p">]</span><span class="o">+</span><span class="n">subpopulations</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">/=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c"># This function only works on numpy &gt;= 1.7, on life we have 1.6</span>
        <span class="c"># ind = np.random.choice(range(len(self.altStructPQ)), p=weights)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sizePQ</span><span class="p">()),</span> <span class="n">weights</span><span class="p">))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># The first value of the distribution is always the cluster center</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;cluster center&quot;</span>
            <span class="k">return</span> <span class="n">centerPair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># pick an alternative structure from the priority queue</span>
            <span class="k">print</span> <span class="s">&quot;alternative structure&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pdb</span>
</div>
<div class="viewcode-block" id="AltStructures.cleanPQ"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.AltStructures.cleanPQ">[docs]</a>    <span class="k">def</span> <span class="nf">cleanPQ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Ensure that the alternative structures priority queue has no more</span>
<span class="sd">            elements than the limit in order to ensure efficiency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limitSize</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">limitSize</span><span class="o">-</span><span class="n">limit</span><span class="p">:]</span>
</div>
<div class="viewcode-block" id="AltStructures.addStructure"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.AltStructures.addStructure">[docs]</a>    <span class="k">def</span> <span class="nf">addStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PDB</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThreshold</span><span class="p">,</span> <span class="n">similarityEvaluator</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">priority</span><span class="p">,</span> <span class="n">subCluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">:</span>
            <span class="n">isSimilar</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">similarityEvaluator</span><span class="o">.</span><span class="n">isElement</span><span class="p">(</span><span class="n">PDB</span><span class="p">,</span> <span class="n">subCluster</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThreshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">subCluster</span><span class="o">.</span><span class="n">threshold</span><span class="o">/</span><span class="mf">2.0</span><span class="p">:</span>
                <span class="n">subCluster</span><span class="o">.</span><span class="n">addElement</span><span class="p">([])</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">,</span> <span class="p">(</span><span class="n">subCluster</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="n">subCluster</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">limitSize</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cleanPQ</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">newCluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span><span class="n">PDB</span><span class="p">,</span> <span class="n">thresholdRadius</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">contactThreshold</span><span class="o">=</span><span class="n">contactThreshold</span><span class="p">,</span> <span class="n">contactMap</span><span class="o">=</span><span class="n">similarityEvaluator</span><span class="o">.</span><span class="n">contactMap</span><span class="p">)</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">newCluster</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">limitSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanPQ</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AltStructures.sizePQ"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.AltStructures.sizePQ">[docs]</a>    <span class="k">def</span> <span class="nf">sizePQ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">altStructPQ</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Cluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster">[docs]</a><span class="k">class</span> <span class="nc">Cluster</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A cluster contains a representative structure(pdb), the number of</span>
<span class="sd">        elements, its density, threshold, number of contacts,</span>
<span class="sd">        a contactMap(sometimes) and a metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">thresholdRadius</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contactMap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">contacts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[],</span> <span class="n">metricCol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">contactThreshold</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">altSelection</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            contacts stands for contacts/ligandAtom</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">pdb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altStructure</span> <span class="o">=</span> <span class="n">AltStructures</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">thresholdRadius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="n">density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="n">contacts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="n">contactMap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalMetrics</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span> <span class="o">=</span> <span class="n">metricCol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactThreshold</span> <span class="o">=</span> <span class="n">contactThreshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span> <span class="o">=</span> <span class="n">altSelection</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold2</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold2</span> <span class="o">=</span> <span class="n">thresholdRadius</span><span class="o">*</span><span class="n">thresholdRadius</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;pdb&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="p">,</span> <span class="s">&quot;altStructure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructure</span><span class="p">,</span>
                 <span class="s">&quot;elements&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="s">&quot;threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                 <span class="s">&quot;densitiy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span><span class="p">,</span> <span class="s">&quot;contacts&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span><span class="p">,</span>
                 <span class="s">&quot;contactMap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span><span class="p">,</span>  <span class="s">&quot;metrics&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                 <span class="s">&quot;metricCol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span><span class="p">,</span> <span class="s">&quot;threshold2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold2</span><span class="p">,</span>
                 <span class="s">&quot;contactThreshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThreshold</span><span class="p">,</span>
                 <span class="s">&quot;altSelection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span><span class="p">,</span>
                 <span class="s">&quot;originalMetrics&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">originalMetrics</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;pdb&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altStructure</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;altStructure&#39;</span><span class="p">,</span> <span class="n">AltStructures</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;elements&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;threshold&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;density&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contacts&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contactMap&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;metrics&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalMetrics</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;originalMetrics&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;metricCol&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;threshold2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactThreshold</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contactThreshold&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;altSelection&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

<div class="viewcode-block" id="Cluster.getMetric"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster.getMetric">[docs]</a>    <span class="k">def</span> <span class="nf">getMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metricCol</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Cluster.getMetricFromColumn"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster.getMetricFromColumn">[docs]</a>    <span class="k">def</span> <span class="nf">getMetricFromColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numcol</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">numcol</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Cluster.addElement"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster.addElement">[docs]</a>    <span class="k">def</span> <span class="nf">addElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Special case where cluster in created during clustering of</span>
            <span class="c"># initial structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">originalMetrics</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">originalMetrics</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">):</span>
            <span class="c"># Set all metrics to the minimum value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.printCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster.printCluster">[docs]</a>    <span class="k">def</span> <span class="nf">printCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">printAtoms</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;Elements: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
        <span class="k">print</span> <span class="s">&quot;Metrics: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Radius threshold: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">print</span> <span class="s">&quot;Number of contacts: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span>
</div>
<div class="viewcode-block" id="Cluster.writePDB"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster.writePDB">[docs]</a>    <span class="k">def</span> <span class="nf">writePDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">writePDB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Cluster.getContacts"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster.getContacts">[docs]</a>    <span class="k">def</span> <span class="nf">getContacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span>
</div>
<div class="viewcode-block" id="Cluster.writeSpawningStructure"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Cluster.writeSpawningStructure">[docs]</a>    <span class="k">def</span> <span class="nf">writeSpawningStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            With 50 % probability select the cluster center to spawn in</span>
<span class="sd">            the next epoch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">altStructure</span><span class="o">.</span><span class="n">sizePQ</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;cluster center&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">writePDB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">altStructure</span><span class="o">.</span><span class="n">altSpawnSelection</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="p">))</span><span class="o">.</span><span class="n">writePDB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">pdb</span>\
             <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">elements</span>\
             <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">threshold</span>\
             <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">contacts</span>\
             <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ContactsClusteringEvaluator"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactsClusteringEvaluator">[docs]</a><span class="k">class</span> <span class="nc">ContactsClusteringEvaluator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RMSDCalculator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RMSDCalculator</span> <span class="o">=</span> <span class="n">RMSDCalculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Only here for compatibility purpose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;RMSDCalculator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RMSDCalculator</span><span class="p">,</span>
                 <span class="s">&quot;contacts&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span><span class="p">,</span> <span class="s">&quot;contactMap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RMSDCalculator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;RMSDCalculator&#39;</span><span class="p">,</span> <span class="n">RMSDCalculator</span><span class="o">.</span><span class="n">RMSDCalculator</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contacts&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contactMap&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ContactsClusteringEvaluator.isElement"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactsClusteringEvaluator.isElement">[docs]</a>    <span class="k">def</span> <span class="nf">isElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RMSDCalculator</span><span class="o">.</span><span class="n">computeRMSD</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">pdb</span><span class="p">,</span> <span class="n">pdb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">cluster</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">dist</span>
</div>
<div class="viewcode-block" id="ContactsClusteringEvaluator.cleanContactMap"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactsClusteringEvaluator.cleanContactMap">[docs]</a>    <span class="k">def</span> <span class="nf">cleanContactMap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="ContactsClusteringEvaluator.checkAttributes"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactsClusteringEvaluator.checkAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">checkAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">countContacts</span><span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContactsClusteringEvaluator.getOuterLimit"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactsClusteringEvaluator.getOuterLimit">[docs]</a>    <span class="k">def</span> <span class="nf">getOuterLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c"># return max(node.cluster.threshold2, node.cluster.threshold2 + 10 - node.depth)</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">threshold2</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">threshold2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">threshold2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ContactsClusteringEvaluator.getInnerLimit"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactsClusteringEvaluator.getInnerLimit">[docs]</a>    <span class="k">def</span> <span class="nf">getInnerLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cluster</span><span class="o">.</span><span class="n">threshold2</span>

</div></div>
<div class="viewcode-block" id="CMClusteringEvaluator"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.CMClusteringEvaluator">[docs]</a><span class="k">class</span> <span class="nc">CMClusteringEvaluator</span><span class="p">:</span>
    <span class="n">limitSlope</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="n">limitMax</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">similarityEvaluator</span><span class="p">,</span> <span class="n">symmetryEvaluator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span> <span class="o">=</span> <span class="n">similarityEvaluator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span> <span class="o">=</span> <span class="n">symmetryEvaluator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;similarityEvaluator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span><span class="p">,</span>
                 <span class="s">&quot;symmetryEvaluator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="p">,</span>
                 <span class="s">&quot;contacts&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span><span class="p">,</span> <span class="s">&quot;contactMap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;similarityEvaluator&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;symmetryEvaluator&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contacts&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contactMap&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CMClusteringEvaluator.isElement"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.CMClusteringEvaluator.isElement">[docs]</a>    <span class="k">def</span> <span class="nf">isElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="o">.</span><span class="n">createContactMap</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">)</span>
            <span class="c"># self.contactMap, foo = self.symmetryEvaluator.createContactMap(pdb, resname, contactThresholdDistance)</span>
            <span class="c"># self.contacts = pdb.countContacts(resname, 8)  # contactThresholdDistance)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span><span class="o">.</span><span class="n">isSimilarCluster</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">contactMap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">cluster</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">distance</span>
</div>
<div class="viewcode-block" id="CMClusteringEvaluator.cleanContactMap"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.CMClusteringEvaluator.cleanContactMap">[docs]</a>    <span class="k">def</span> <span class="nf">cleanContactMap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="CMClusteringEvaluator.checkAttributes"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.CMClusteringEvaluator.checkAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">checkAttributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contactMap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="o">.</span><span class="n">createContactMap</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">)</span>
            <span class="c"># self.contactMap, foo = self.symmetryEvaluator.createContactMap(pdb, resname, contactThresholdDistance)</span>
            <span class="c"># self.contacts = pdb.countContacts(resname, 8)  # contactThresholdDistance)</span>
</div>
<div class="viewcode-block" id="CMClusteringEvaluator.getInnerLimit"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.CMClusteringEvaluator.getInnerLimit">[docs]</a>    <span class="k">def</span> <span class="nf">getInnerLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">):</span>
        <span class="c"># if cluster.contacts &gt; self.limitMax[cluster.contactThreshold]:</span>
        <span class="c">#     return 4.0</span>
        <span class="c"># else:</span>
        <span class="c">#     return 16-self.limitSlope[cluster.contactThreshold]*cluster.contacts</span>

        <span class="c"># if cluster.contacts &gt; 2.0:</span>
        <span class="c">#     return 4.0</span>
        <span class="c"># elif cluster.contacts &lt;= 0.5:</span>
        <span class="c">#     return 25.0</span>
        <span class="c"># else:</span>
        <span class="c">#     return 25-14*(cluster.contacts-0.5)</span>

        <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">contacts</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">4.0</span>
        <span class="k">elif</span> <span class="n">cluster</span><span class="o">.</span><span class="n">contacts</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">25.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">16</span><span class="o">-</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">contacts</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c"># if cluster.contacts &gt; 1.0:</span>
        <span class="c">#     return 4.0</span>
        <span class="c"># elif cluster.contacts &gt; 0.75:</span>
        <span class="c">#     return 9.0</span>
        <span class="c"># elif cluster.contacts &gt; 0.5:</span>
        <span class="c">#     return 16.0</span>
        <span class="c"># else:</span>
        <span class="c">#      return 25</span>
</div>
<div class="viewcode-block" id="CMClusteringEvaluator.getOuterLimit"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.CMClusteringEvaluator.getOuterLimit">[docs]</a>    <span class="k">def</span> <span class="nf">getOuterLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c"># return max(16, 16 * 2 - node.depth)</span>
        <span class="k">return</span> <span class="mi">16</span>

</div></div>
<div class="viewcode-block" id="Clustering"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering">[docs]</a><span class="k">class</span> <span class="nc">Clustering</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base class for clustering methods, it defines a cluster method that</span>
<span class="sd">        contacts and accumulative inherit and use</span>

<span class="sd">        resname [In] String containing the three letter name of the ligan in the pdb</span>
<span class="sd">        reportBaseFilename [In] Name of the file that contains the metrics of the snapshots to cluster</span>
<span class="sd">        columnOfReportFile [In] Column of the report file that contain the metric of interest</span>
<span class="sd">        contactThresholdDistance [In] Distance at wich a ligand atom and a protein atom are</span>
<span class="sd">        considered in contact(default 8)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">columnOfReportFile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                 <span class="n">altSelection</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;BaseClass&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">Clusters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reportBaseFilename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">=</span> <span class="n">reportBaseFilename</span> <span class="o">+</span> <span class="s">&quot;_</span><span class="si">%d</span><span class="s">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="n">resname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">columnOfReportFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span> <span class="o">=</span> <span class="n">contactThresholdDistance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span> <span class="o">=</span> <span class="n">altSelection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;clusters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span>
                 <span class="s">&quot;reportBaseFilename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span><span class="p">,</span>
                 <span class="s">&quot;resname&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="s">&quot;col&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="s">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                 <span class="s">&quot;symmetries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span><span class="p">,</span>
                 <span class="s">&quot;conformationNetwork&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="p">,</span>
                 <span class="s">&quot;contactThresholdDistance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span>
                 <span class="s">&quot;altSelection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;clusters&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;reportBaseFilename&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;col&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contactThresholdDistance&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;symmetries&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;altSelection&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;conformationNetwork&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;metricCol&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Clustering.setCol"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.setCol">[docs]</a>    <span class="k">def</span> <span class="nf">setCol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>

        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">cluster</span><span class="o">.</span><span class="n">metricCol</span> <span class="o">=</span> <span class="n">col</span>
</div>
<div class="viewcode-block" id="Clustering.getCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.getCluster">[docs]</a>    <span class="k">def</span> <span class="nf">getCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusterNum</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">getCluster</span><span class="p">(</span><span class="n">clusterNum</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Clustering.clusterIterator"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.clusterIterator">[docs]</a>    <span class="k">def</span> <span class="nf">clusterIterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># TODO: may be interesting to add some condition to filter, check</span>
        <span class="c"># itertools module, its probably implemented</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cluster</span>
</div>
<div class="viewcode-block" id="Clustering.getNumberClusters"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.getNumberClusters">[docs]</a>    <span class="k">def</span> <span class="nf">getNumberClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">getNumberClusters</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">clusters</span>\
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">reportBaseFilename</span>\
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">resname</span>\
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">col</span>

<div class="viewcode-block" id="Clustering.clusterInitialStructures"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.clusterInitialStructures">[docs]</a>    <span class="k">def</span> <span class="nf">clusterInitialStructures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialStructures</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Cluster the initial structures. This will allow to obtain a working</span>
<span class="sd">            processor to cluster mapping (see SimulationRunner docs for more info)</span>
<span class="sd">            for simulation with multiple initial structures</span>
<span class="sd">            :param initialStructures: List of the initial structures of the simulation</span>
<span class="sd">            :type initialStructures: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clusterInitial</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">structurePath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">initialStructures</span><span class="p">):</span>
            <span class="n">pdb</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">structurePath</span><span class="p">),</span> <span class="n">resname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">clusterNum</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
                <span class="n">scd</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">computeSquaredCentroidDifference</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">pdb</span><span class="p">,</span> <span class="n">pdb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scd</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">getInnerLimit</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">isSimilar</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">isElement</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isSimilar</span><span class="p">:</span>
                    <span class="n">cluster</span><span class="o">.</span><span class="n">addElement</span><span class="p">([])</span>
                    <span class="n">clusterInitial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clusterNum</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">clusterNum</span><span class="p">]</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusterInitial</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="c"># If an initial structure is similar enough to be added as</span>
                <span class="c"># element in a previous cluster, move to the next structure,</span>
                <span class="c"># this function is practically a duplicate of the</span>
                <span class="c"># addSnapshotToCluster function and this blocks substitutes the</span>
                <span class="c"># return statement after adding an element</span>
                <span class="k">continue</span>
            <span class="c"># if made it here, the snapshot was not added into any cluster</span>
            <span class="c"># Check if contacts and contactMap are set (depending on which kind</span>
            <span class="c"># of clustering)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">checkAttributes</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">)</span>
            <span class="n">contacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">contacts</span>
            <span class="n">numberOfLigandAtoms</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">getNumberOfAtoms</span><span class="p">()</span>
            <span class="n">contactsPerAtom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span><span class="o">/</span><span class="n">numberOfLigandAtoms</span>

            <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">contactsPerAtom</span><span class="p">)</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">thresholdRadius</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                            <span class="n">contacts</span><span class="o">=</span><span class="n">contactsPerAtom</span><span class="p">,</span>
                            <span class="n">contactMap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">contactMap</span><span class="p">,</span>
                            <span class="n">metrics</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metricCol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">,</span>
                            <span class="n">contactThreshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span>
                            <span class="n">altSelection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">addCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
            <span class="n">clusterNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumberClusters</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">clusterInitial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clusterNum</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">clusterNum</span><span class="p">]</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">clusterNum</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clusterInitial</span>
</div>
<div class="viewcode-block" id="Clustering.cluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.cluster">[docs]</a>    <span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">processorsToClusterMapping</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Cluster the snaptshots contained in the pahts folder</span>
<span class="sd">            :param paths: List of folders with the snapshots</span>
<span class="sd">            :type paths: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">trajectories</span> <span class="o">=</span> <span class="n">getAllTrajectories</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">:</span>
            <span class="n">trajNum</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getTrajNum</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">origCluster</span> <span class="o">=</span> <span class="n">processorsToClusterMapping</span><span class="p">[</span><span class="n">trajNum</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">snapshots</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span><span class="p">:</span>
                <span class="n">reportFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">%</span> <span class="n">trajNum</span><span class="p">)</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">reportFilename</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">snapshots</span><span class="p">):</span>
                    <span class="n">origCluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSnapshotToCluster</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">origCluster</span><span class="p">,</span> <span class="n">metrics</span><span class="p">[</span><span class="n">num</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">snapshots</span><span class="p">):</span>
                    <span class="n">origCluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addSnapshotToCluster</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">origCluster</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">:</span>
            <span class="n">cluster</span><span class="o">.</span><span class="n">altStructure</span><span class="o">.</span><span class="n">cleanPQ</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Clustering.writeOutput"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writeOutput">[docs]</a>    <span class="k">def</span> <span class="nf">writeOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">,</span> <span class="n">degeneracy</span><span class="p">,</span> <span class="n">outputObject</span><span class="p">,</span> <span class="n">writeAll</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Writes all the clustering information in outputPath</span>

<span class="sd">            :param outputPath: Folder that will contain all the clustering information</span>
<span class="sd">            :type outputPath: str</span>
<span class="sd">            :param degeneracy: Degeneracy of each cluster. It must be in the same order</span>
<span class="sd">            as in the self.clusters list</span>
<span class="sd">            :type degeneracy: list</span>
<span class="sd">            :param outputObject: Output name for the pickle object</span>
<span class="sd">            :type outputObject: str</span>
<span class="sd">            :param writeAll: Wether to write pdb files for all cluster in addition</span>
<span class="sd">            of the summary</span>
<span class="sd">            :type writeAll: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">outputPath</span><span class="p">)</span>
        <span class="n">utilities</span><span class="o">.</span><span class="n">makeFolder</span><span class="p">(</span><span class="n">outputPath</span><span class="p">)</span>

        <span class="n">summaryFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="s">&quot;summary.txt&quot;</span><span class="p">)</span>
        <span class="n">summaryFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">summaryFilename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">summaryFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;#cluster size degeneracy contacts threshold density metric</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">writeAll</span><span class="p">:</span>
                <span class="n">outputFilename</span> <span class="o">=</span> <span class="s">&quot;cluster_</span><span class="si">%d</span><span class="s">.pdb&quot;</span> <span class="o">%</span> <span class="n">i</span>
                <span class="n">outputFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="n">outputFilename</span><span class="p">)</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">writePDB</span><span class="p">(</span><span class="n">outputFilename</span><span class="p">)</span>

            <span class="n">metric</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">getMetric</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">writeString</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%.2f</span><span class="s"> </span><span class="si">%.4f</span><span class="s"> </span><span class="si">%.1f</span><span class="s"> -</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span>
                                                               <span class="n">degeneracy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                               <span class="n">cluster</span><span class="o">.</span><span class="n">contacts</span><span class="p">,</span>
                                                               <span class="n">cluster</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                                                               <span class="n">cluster</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">writeString</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%.2f</span><span class="s"> </span><span class="si">%.4f</span><span class="s"> </span><span class="si">%.1f</span><span class="s"> </span><span class="si">%.3f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span>
                                                                  <span class="n">degeneracy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                  <span class="n">cluster</span><span class="o">.</span><span class="n">contacts</span><span class="p">,</span>
                                                                  <span class="n">cluster</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                                                                  <span class="n">cluster</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                                                                  <span class="n">metric</span><span class="p">)</span>
            <span class="n">summaryFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writeString</span><span class="p">)</span>
        <span class="n">summaryFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputObject</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Clustering.addSnapshotToCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.addSnapshotToCluster">[docs]</a>    <span class="k">def</span> <span class="nf">addSnapshotToCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">origCluster</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[],</span> <span class="n">col</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">pdb</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">cleanContactMap</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">clusterNum</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
            <span class="n">scd</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">computeSquaredCentroidDifference</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">pdb</span><span class="p">,</span> <span class="n">pdb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scd</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">getInnerLimit</span><span class="p">(</span><span class="n">cluster</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">isSimilar</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">isElement</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isSimilar</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">cluster</span><span class="o">.</span><span class="n">threshold</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">cluster</span><span class="o">.</span><span class="n">altStructure</span><span class="o">.</span><span class="n">addStructure</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="p">)</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">addElement</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">origCluster</span><span class="p">,</span> <span class="n">clusterNum</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="p">[</span><span class="n">origCluster</span><span class="p">][</span><span class="n">clusterNum</span><span class="p">][</span><span class="s">&#39;transition&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">origCluster</span><span class="p">,</span> <span class="n">clusterNum</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">clusterNum</span>

        <span class="c"># if made it here, the snapshot was not added into any cluster</span>
        <span class="c"># Check if contacts and contactMap are set (depending on which kind</span>
        <span class="c"># of clustering)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">checkAttributes</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">)</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">contacts</span>
        <span class="n">numberOfLigandAtoms</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">getNumberOfAtoms</span><span class="p">()</span>
        <span class="n">contactsPerAtom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span><span class="o">/</span><span class="n">numberOfLigandAtoms</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">contactsPerAtom</span><span class="p">)</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">thresholdRadius</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                          <span class="n">contacts</span><span class="o">=</span><span class="n">contactsPerAtom</span><span class="p">,</span>
                          <span class="n">contactMap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="o">.</span><span class="n">contactMap</span><span class="p">,</span>
                          <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">metricCol</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
                          <span class="n">contactThreshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span>
                          <span class="n">altSelection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">addCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
        <span class="n">clusterNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">getNumberClusters</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">clusterNum</span> <span class="o">==</span> <span class="n">origCluster</span><span class="p">:</span>
            <span class="c"># The clusterNum should only be equal to origCluster when the first</span>
            <span class="c"># cluster is created and the clusterInitialStructures function has</span>
            <span class="c"># not been called, i.e. when usind the compareClustering script</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">clusterNum</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">clusterNum</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">origCluster</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">origCluster</span><span class="p">,</span> <span class="n">clusterNum</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># If a new cluster is discovered during a trajectory, the next step in</span>
        <span class="c"># the same trajectory will be considered to start from these new</span>
        <span class="c"># cluster, thus resulting in a more precise conformation network and</span>
        <span class="c"># smoother pathways</span>
        <span class="k">return</span> <span class="n">clusterNum</span>
</div>
<div class="viewcode-block" id="Clustering.writeConformationNetwork"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writeConformationNetwork">[docs]</a>    <span class="k">def</span> <span class="nf">writeConformationNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write the conformational network to file to visualize it</span>
<span class="sd">            :param path: Path where to write the network</span>
<span class="sd">            :type path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">write_edgelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Clustering.writeFDT"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writeFDT">[docs]</a>    <span class="k">def</span> <span class="nf">writeFDT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write the first discovery tree to file in edgelist format to</span>
<span class="sd">            visualize it</span>
<span class="sd">            :param path: Path where to write the network</span>
<span class="sd">            :type path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;root&#39;</span><span class="p">:</span>
                    <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;parent&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Clustering.writeConformationNodeMetric"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writeConformationNodeMetric">[docs]</a>    <span class="k">def</span> <span class="nf">writeConformationNodeMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">metricCol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write the metric of each node in the conformation network in a</span>
<span class="sd">            tab-separated file</span>
<span class="sd">            :param path: Path where to write the network</span>
<span class="sd">            :type path: str</span>
<span class="sd">            :param metricCol: Column of the metric of interest</span>
<span class="sd">            :type metricCol: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">getMetricFromColumn</span><span class="p">(</span><span class="n">metricCol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="s">-</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%.4f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Clustering.writeConformationNodePopulation"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writeConformationNodePopulation">[docs]</a>    <span class="k">def</span> <span class="nf">writeConformationNodePopulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write the population of each node in the conformation network in a</span>
<span class="sd">            tab-separated file</span>
<span class="sd">            :param path: Path where to write the network</span>
<span class="sd">            :type path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="Clustering.createPathwayToCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.createPathwayToCluster">[docs]</a>    <span class="k">def</span> <span class="nf">createPathwayToCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusterLeave</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Retrace the FDT from a specific cluster to the root where it was</span>
<span class="sd">            discovered</span>
<span class="sd">            :param clusterLeave: End point of the pathway to reconstruct</span>
<span class="sd">            :type clusterLeave: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pathway</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodeLabel</span> <span class="o">=</span> <span class="n">clusterLeave</span>
        <span class="k">while</span> <span class="n">nodeLabel</span> <span class="o">!=</span> <span class="s">&quot;root&quot;</span><span class="p">:</span>
            <span class="n">pathway</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodeLabel</span><span class="p">)</span>
            <span class="n">nodeLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">nodeLabel</span><span class="p">][</span><span class="s">&#39;parent&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pathway</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Clustering.getOptimalMetric"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.getOptimalMetric">[docs]</a>    <span class="k">def</span> <span class="nf">getOptimalMetric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Find the cluster with the best metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimalMetric</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">optimalMetricIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">getMetric</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">getMetricFromColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">&lt;</span> <span class="n">optimalMetric</span><span class="p">:</span>
                <span class="n">optimalMetric</span> <span class="o">=</span> <span class="n">metric</span>
                <span class="n">optimalMetricIndex</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">optimalMetricIndex</span>
</div>
<div class="viewcode-block" id="Clustering.writePathwayTrajectory"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writePathwayTrajectory">[docs]</a>    <span class="k">def</span> <span class="nf">writePathwayTrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathway</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write a list of cluster forming a pathway into a trajectory pdb file</span>
<span class="sd">            :param pathway: List of clusters that form the pathway</span>
<span class="sd">            :type pathway: list</span>
<span class="sd">            :param filename: Path where to write the trajectory</span>
<span class="sd">            :type filename: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pathwayFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">pathwayFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;REMARK 000 File created using PELE++</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">pathwayFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;REMARK 000 Pathway trajectory created using the FDT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">pathwayFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;REMARK 000 List of cluster belonging to the pathway </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathway</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step_cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathway</span><span class="p">):</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">step_cluster</span><span class="p">]</span>
            <span class="n">pathwayFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;MODEL </span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">pdbStr</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">pdb</span>
            <span class="n">pdbList</span> <span class="o">=</span> <span class="n">pdbStr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pdbList</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c"># Avoid writing previous REMARK block</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;REMARK &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;MODEL &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s">&quot;END&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">pathwayFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">pathwayFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ENDMDL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">pathwayFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Clustering.writePathwayOptimalCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writePathwayOptimalCluster">[docs]</a>    <span class="k">def</span> <span class="nf">writePathwayOptimalCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extracte the pathway to the cluster with the best metric as a</span>
<span class="sd">            trajectory and  write it to a PDB file</span>
<span class="sd">            :param filename: Path where to write the trajectory</span>
<span class="sd">            :type filename: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimalCluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOptimalMetric</span><span class="p">()</span>
        <span class="n">pathway</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createPathwayToCluster</span><span class="p">(</span><span class="n">optimalCluster</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writePathwayTrajectory</span><span class="p">(</span><span class="n">pathway</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Clustering.calculateMetastabilityIndex"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.calculateMetastabilityIndex">[docs]</a>    <span class="k">def</span> <span class="nf">calculateMetastabilityIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the metastablity index, mI. mI is the ratio of transitions</span>
<span class="sd">            from a given cluster that remains within the same cluster</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metInd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
            <span class="n">totalOut</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">selfTrans</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="o">.</span><span class="n">out_edges_iter</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">edge</span> <span class="o">==</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">selfTrans</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;transition&#39;</span><span class="p">]</span>
                <span class="n">totalOut</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;transition&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">totalOut</span><span class="o">+</span><span class="n">selfTrans</span><span class="p">:</span>
                <span class="n">metInd</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfTrans</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">totalOut</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metInd</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">metInd</span>
</div>
<div class="viewcode-block" id="Clustering.writeMetastabilityIndex"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.Clustering.writeMetastabilityIndex">[docs]</a>    <span class="k">def</span> <span class="nf">writeMetastabilityIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">metInd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Write the metastability index of each node to file.</span>
<span class="sd">            :param filename: Path where to write the trajectory</span>
<span class="sd">            :type filename: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">metInd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">metInd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateMetastabilityIndex</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">metInd</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%.4f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">met</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="ContactsClustering"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactsClustering">[docs]</a><span class="k">class</span> <span class="nc">ContactsClustering</span><span class="p">(</span><span class="n">Clustering</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cluster together all snapshots that are closer to the cluster center</span>
<span class="sd">        than certain threshold. This threshold is assigned according to the</span>
<span class="sd">        ratio of number of contacts over the number of heavy atoms of the ligand</span>

<span class="sd">        thresholdCalculator [In] ThresholdCalculator object that calculate the</span>
<span class="sd">        threshold according to the contacts ratio</span>
<span class="sd">        resname [In] String containing the three letter name of the ligand</span>
<span class="sd">        in the pdb</span>
<span class="sd">        reportBaseFilename [In] Name of the file that contains the metrics of</span>
<span class="sd">        the snapshots to cluster</span>
<span class="sd">        columnOfReportFile [In] Column of the report file that contain the</span>
<span class="sd">        metric of interest</span>
<span class="sd">        contactThresholdDistance [In] Distance at wich a ligand atom and a protein atom are</span>
<span class="sd">        considered in contact(default 8)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thresholdCalculator</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">reportBaseFilename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">columnOfReportFile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">contactThresholdDistance</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">symmetries</span><span class="o">=</span><span class="p">[],</span> <span class="n">altSelection</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">Clustering</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="p">,</span>
                           <span class="n">columnOfReportFile</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">,</span>
                            <span class="n">altSelection</span><span class="o">=</span><span class="n">altSelection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">clusteringTypes</span><span class="o">.</span><span class="n">CLUSTERING_TYPES</span><span class="o">.</span><span class="n">contacts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span> <span class="o">=</span> <span class="n">thresholdCalculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span> <span class="o">=</span> <span class="n">symmetries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span> <span class="o">=</span> <span class="n">ContactsClusteringEvaluator</span><span class="p">(</span><span class="n">RMSDCalculator</span><span class="o">.</span><span class="n">RMSDCalculator</span><span class="p">(</span><span class="n">symmetries</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;clusters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span>
                 <span class="s">&quot;reportBaseFilename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span><span class="p">,</span>
                 <span class="s">&quot;resname&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="s">&quot;col&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="s">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                 <span class="s">&quot;symmetries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span><span class="p">,</span>
                 <span class="s">&quot;conformationNetwork&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="p">,</span>
                 <span class="s">&quot;contactThresholdDistance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span>
                 <span class="s">&quot;altSelection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span><span class="p">,</span>
                 <span class="s">&quot;thresholdCalculator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span><span class="p">,</span>
                 <span class="s">&quot;clusteringEvaluator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;clusters&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;reportBaseFilename&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;col&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contactThresholdDistance&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;symmetries&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;altSelection&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;conformationNetwork&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;metricCol&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;thresholdCalculator&#39;</span><span class="p">,</span> <span class="n">thresholdcalculator</span><span class="o">.</span><span class="n">ThresholdCalculatorConstant</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;clusteringEvaluator&#39;</span><span class="p">,</span> <span class="n">ContactsClusteringEvaluator</span><span class="p">(</span><span class="n">RMSDCalculator</span><span class="o">.</span><span class="n">RMSDCalculator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span><span class="p">)))</span>

</div>
<div class="viewcode-block" id="ContactMapAccumulativeClustering"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactMapAccumulativeClustering">[docs]</a><span class="k">class</span> <span class="nc">ContactMapAccumulativeClustering</span><span class="p">(</span><span class="n">Clustering</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Cluster together all snapshots that have similar enough contactMaps.</span>
<span class="sd">        This similarity can be calculated with different methods (see similariyEvaluator documentation)</span>

<span class="sd">        thresholdCalculator [In] ThresholdCalculator object that calculate the threshold</span>
<span class="sd">        similarityEvaluator [In] SimilarityEvaluator object that will determine wether two snapshots</span>
<span class="sd">        are similar enough to belong to the same cluster</span>
<span class="sd">        resname [In] String containing the three letter name of the ligan in the pdb</span>
<span class="sd">        reportBaseFilename [In] Name of the file that contains the metrics of the snapshots to cluster</span>
<span class="sd">        columnOfReportFile [In] Column of the report file that contain the metric of interest</span>
<span class="sd">        contactThresholdDistance [In] Distance at wich a ligand atom and a protein</span>
<span class="sd">        atom are considered in contact(default 8)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thresholdCalculator</span><span class="p">,</span> <span class="n">similarityEvaluator</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">reportBaseFilename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">columnOfReportFile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">contactThresholdDistance</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">symmetries</span><span class="o">=</span><span class="p">[],</span> <span class="n">altSelection</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">Clustering</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="p">,</span>
                            <span class="n">columnOfReportFile</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">,</span>
                            <span class="n">altSelection</span><span class="o">=</span><span class="n">altSelection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">clusteringTypes</span><span class="o">.</span><span class="n">CLUSTERING_TYPES</span><span class="o">.</span><span class="n">contactMapAccumulative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span> <span class="o">=</span> <span class="n">thresholdCalculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span> <span class="o">=</span> <span class="n">similarityEvaluator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">SymmetryContactMapEvaluator</span><span class="p">(</span><span class="n">symmetries</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span> <span class="o">=</span> <span class="n">CMClusteringEvaluator</span><span class="p">(</span><span class="n">similarityEvaluator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Defining pickling interface to avoid problems when working with old</span>
        <span class="c"># simulations if the properties of the clustering-related classes have</span>
        <span class="c"># changed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;clusters&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span>
                 <span class="s">&quot;reportBaseFilename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span><span class="p">,</span>
                 <span class="s">&quot;resname&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="s">&quot;col&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="s">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
                 <span class="s">&quot;symmetries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span><span class="p">,</span>
                 <span class="s">&quot;conformationNetwork&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span><span class="p">,</span>
                 <span class="s">&quot;contactThresholdDistance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span>
                 <span class="s">&quot;altSelection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span><span class="p">,</span>
                 <span class="s">&quot;thresholdCalculator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span><span class="p">,</span>
                 <span class="s">&quot;similariyEvaluator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span><span class="p">,</span>
                 <span class="s">&quot;symmetryEvaluator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="p">,</span>
                 <span class="s">&quot;clusteringEvaluator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c"># Restore instance attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;clusters&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;reportBaseFilename&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resname&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;col&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;contactThresholdDistance&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;symmetries&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altSelection</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;altSelection&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformationNetwork</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;conformationNetwork&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;metricCol&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholdCalculator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;thresholdCalculator&#39;</span><span class="p">,</span> <span class="n">thresholdcalculator</span><span class="o">.</span><span class="n">ThresholdCalculatorConstant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;similariyEvaluator&#39;</span><span class="p">,</span> <span class="n">JaccardEvaluator</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;symmetryEvaluator&#39;</span><span class="p">,</span> <span class="n">sym</span><span class="o">.</span><span class="n">SymmetryContactMapEvaluator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetries</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusteringEvaluator</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;clusteringEvaluator&#39;</span><span class="p">,</span> <span class="n">CMClusteringEvaluator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarityEvaluator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="SequentialLastSnapshotClustering"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.SequentialLastSnapshotClustering">[docs]</a><span class="k">class</span> <span class="nc">SequentialLastSnapshotClustering</span><span class="p">(</span><span class="n">Clustering</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigned  the last snapshot of the trajectory to a cluster.</span>
<span class="sd">        Only useful for PELE sequential runs</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SequentialLastSnapshotClustering.cluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.SequentialLastSnapshotClustering.cluster">[docs]</a>    <span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Cluster the snaptshots contained in the pahts folder</span>
<span class="sd">            paths [In] List of folders with the snapshots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Clean clusters at every step, so we only have the last snapshot of</span>
        <span class="c"># each trajectory as clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">Clusters</span><span class="p">()</span>
        <span class="n">trajectories</span> <span class="o">=</span> <span class="n">getAllTrajectories</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">:</span>
            <span class="n">trajNum</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getTrajNum</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>

            <span class="n">snapshots</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span><span class="p">:</span>
                <span class="n">reportFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span> <span class="o">%</span> <span class="n">trajNum</span><span class="p">)</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">reportFilename</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c"># Pass as cluster metrics the minimum value for each metric,</span>
                <span class="c"># thus the metrics are not valid to do any spawning, only to</span>
                <span class="c"># check the exit condition</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">addSnapshotToCluster</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addSnapshotToCluster</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="SequentialLastSnapshotClustering.addSnapshotToCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.SequentialLastSnapshotClustering.addSnapshotToCluster">[docs]</a>    <span class="k">def</span> <span class="nf">addSnapshotToCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[],</span> <span class="n">col</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">pdb</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">)</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">countContacts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">)</span>
        <span class="n">numberOfLigandAtoms</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">getNumberOfAtoms</span><span class="p">()</span>
        <span class="n">contactsPerAtom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span><span class="o">/</span><span class="n">numberOfLigandAtoms</span>

        <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">thresholdRadius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">contacts</span><span class="o">=</span><span class="n">contactsPerAtom</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                          <span class="n">metricCol</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">addCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ContactMapClustering"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactMapClustering">[docs]</a><span class="k">class</span> <span class="nc">ContactMapClustering</span><span class="p">(</span><span class="n">Clustering</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">columnOfReportFile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                 <span class="n">symmetries</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">Clustering</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="p">,</span>
                            <span class="n">columnOfReportFile</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">clusteringTypes</span><span class="o">.</span><span class="n">CLUSTERING_TYPES</span><span class="o">.</span><span class="n">contactMapAffinity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">SymmetryContactMapEvaluator</span><span class="p">(</span><span class="n">symmetries</span><span class="p">)</span>

<div class="viewcode-block" id="ContactMapClustering.cluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactMapClustering.cluster">[docs]</a>    <span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cluster the snapshots of the trajectories provided using the</span>
<span class="sd">        affinity propagation algorithm and the contactMaps similarity.</span>

<span class="sd">        A double clustering process is going on. First, all snapshots from an</span>
<span class="sd">        epoch are clustered together, and then these clusters are clustered</span>
<span class="sd">        together with the previous clusters, if any</span>

<span class="sd">        Paths [in] list with the path to the trajectories to cluster&quot;&quot;&quot;</span>
        <span class="n">trajectories</span> <span class="o">=</span> <span class="n">getAllTrajectories</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

        <span class="n">pdb_list</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">contactmaps</span><span class="p">,</span> <span class="n">contacts</span> <span class="o">=</span> <span class="n">processSnapshots</span><span class="p">(</span><span class="n">trajectories</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="p">)</span>
        <span class="n">preferences</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span><span class="n">contactmaps</span><span class="p">)</span>

        <span class="n">preferences</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">preferences</span><span class="p">)</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">preferences</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">preferences</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span> <span class="o">=</span> <span class="n">clusteringResultsParameters</span><span class="p">(</span><span class="n">pdb_list</span><span class="o">=</span><span class="n">pdb_list</span><span class="p">,</span>
                                                            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                                                            <span class="n">contactmaps</span><span class="o">=</span><span class="n">contactmaps</span><span class="p">,</span><span class="n">contacts</span><span class="o">=</span><span class="n">contacts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span> <span class="o">=</span> <span class="n">clusteringResultsParameters</span><span class="p">(</span><span class="n">contactmaps</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">contactmapsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="p">)</span>
        <span class="n">cluster_center_indices</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">clusterContactMaps</span><span class="p">(</span><span class="n">contactmapsArray</span><span class="p">,</span> <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processClusterResults</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="n">cluster_center_indices</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="c"># print &quot;Number of clusters after first clustering&quot;, len(self.firstClusteringParams.newClusters.clusters)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clusterNum</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">contactMap</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;old:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">clusterNum</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>

            <span class="n">preferences</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">preferences</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="c"># preferences = -np.array(self.secondClusteringParams.elements)</span>
            <span class="c"># prefereneces = None</span>
            <span class="n">secondcontactmapsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="p">)</span>
            <span class="n">cluster_center_indices</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">clusterContactMaps</span><span class="p">(</span><span class="n">secondcontactmapsArray</span><span class="p">,</span> <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processClusterResults</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">,</span> <span class="n">cluster_center_indices</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
            <span class="c"># print &quot;Number of clusters after second clustering&quot;, len(self.secondClusteringParams.newClusters.clusters)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">newClusters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">newClusters</span>
</div>
<div class="viewcode-block" id="ContactMapClustering.processClusterResults"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactMapClustering.processClusterResults">[docs]</a>    <span class="k">def</span> <span class="nf">processClusterResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">cluster_center_indices</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Analyse the results obtained from the affinity propagation</span>
<span class="sd">        algorithm.</span>

<span class="sd">        Process [In] String to decide wether it is the results of the first or</span>
<span class="sd">        second clustering</span>
<span class="sd">        cluster_center_indices [In] Numpy array with the snapshots taht are</span>
<span class="sd">        cluster centers</span>
<span class="sd">        Indices [In] Numpy array with the cluster each snapshot belongs to&quot;&quot;&quot;</span>
        <span class="n">center_ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster_center_indices</span><span class="p">:</span>

            <span class="n">cluster_members</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">center_ind</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s">&quot;first&quot;</span><span class="p">:</span>
                <span class="n">elements_in_cluster</span> <span class="o">=</span> <span class="n">cluster_members</span><span class="o">.</span><span class="n">size</span>
                <span class="n">metricsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="n">best_metric_ind</span> <span class="o">=</span> <span class="n">cluster_members</span><span class="p">[</span><span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                <span class="n">best_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">best_metric_ind</span><span class="p">]</span>

                <span class="n">cluster_index</span> <span class="o">=</span> <span class="n">selectRandomCenter</span><span class="p">(</span><span class="n">cluster_members</span><span class="p">,</span>
                                                   <span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">])</span>

                <span class="n">contacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">contacts</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">]</span>
                <span class="n">numberOfLigandAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">pdb_list</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">]</span><span class="o">.</span><span class="n">getNumberOfAtoms</span><span class="p">()</span>
                <span class="n">contactsPerAtom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span><span class="o">/</span><span class="n">numberOfLigandAtoms</span>

                <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">pdb_list</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">],</span>
                                  <span class="n">contactMap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">],</span>
                                  <span class="n">contacts</span><span class="o">=</span><span class="n">contactsPerAtom</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">best_metrics</span><span class="p">,</span> <span class="n">metricCol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>

                <span class="n">cluster</span><span class="o">.</span><span class="n">elements</span> <span class="o">+=</span> <span class="n">elements_in_cluster</span><span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;new:</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">center_ind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">contactMap</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">newClusters</span><span class="o">.</span><span class="n">addCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">elementsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
                <span class="n">metricsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="n">elements_in_cluster</span> <span class="o">=</span> <span class="n">elementsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">selectRandomCenter</span><span class="p">(</span><span class="n">cluster_members</span><span class="p">,</span>
                                           <span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">])</span>
                <span class="n">cluster_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">best_metric_ind</span> <span class="o">=</span> <span class="n">cluster_members</span><span class="p">[</span><span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                <span class="n">best_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">best_metric_ind</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">newClusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
                    <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">newClusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">]</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">best_metrics</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">elements</span> <span class="o">+=</span> <span class="p">(</span><span class="n">elements_in_cluster</span><span class="o">-</span><span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">newClusters</span><span class="o">.</span><span class="n">addCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

            <span class="n">center_ind</span> <span class="o">+=</span> <span class="mi">1</span>

</div></div>
<div class="viewcode-block" id="ContactMapAgglomerativeClustering"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactMapAgglomerativeClustering">[docs]</a><span class="k">class</span> <span class="nc">ContactMapAgglomerativeClustering</span><span class="p">(</span><span class="n">Clustering</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;nclusters[In] Number of the cluster to generate with the hierarchical clustering algorithm</span>
<span class="sd">        resname [In] String containing the three letter name of the ligan in the pdb</span>
<span class="sd">        reportBaseFilename [In] Name of the file that contains the metrics of the snapshots to cluster</span>
<span class="sd">        columnOfReportFile [In] Column of the report file that contain the metric of interest</span>
<span class="sd">        contactThresholdDistance [In] Distance at wich a ligand atom and a protein atom are</span>
<span class="sd">        considered in contact(default 8)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nclusters</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">columnOfReportFile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                 <span class="n">symmetries</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">Clustering</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="p">,</span>
                            <span class="n">columnOfReportFile</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">clusteringTypes</span><span class="o">.</span><span class="n">CLUSTERING_TYPES</span><span class="o">.</span><span class="n">contactMapAgglomerative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nclusters</span> <span class="o">=</span> <span class="n">nclusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">SymmetryContactMapEvaluator</span><span class="p">(</span><span class="n">symmetries</span><span class="p">)</span>

<div class="viewcode-block" id="ContactMapAgglomerativeClustering.cluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactMapAgglomerativeClustering.cluster">[docs]</a>    <span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clusters the snapshots of the trajectories provided using</span>
<span class="sd">         a hierarchical clustering algorithm and the contactMaps similarity.</span>

<span class="sd">        The snapshots are clustered together with the previous found clusters.</span>
<span class="sd">        If and old cluster is found connected to a new one (with the new one</span>
<span class="sd">        being the exemplar) it is ignored and only the new snapshots are</span>
<span class="sd">        counted as members of the cluster. The minimum metric is used as the</span>
<span class="sd">        metric of the cluster&quot;&quot;&quot;</span>
        <span class="n">trajectories</span> <span class="o">=</span> <span class="n">getAllTrajectories</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

        <span class="n">pdb_list</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">contactmaps</span><span class="p">,</span> <span class="n">contacts</span> <span class="o">=</span> <span class="n">processSnapshots</span><span class="p">(</span><span class="n">trajectories</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportBaseFilename</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetryEvaluator</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span> <span class="o">=</span> <span class="n">clusteringResultsParameters</span><span class="p">(</span><span class="n">pdb_list</span><span class="o">=</span><span class="n">pdb_list</span><span class="p">,</span>
                                     <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">contactmaps</span><span class="o">=</span><span class="n">contactmaps</span><span class="p">,</span> <span class="n">contacts</span><span class="o">=</span><span class="n">contacts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span> <span class="o">=</span> <span class="n">clusteringResultsParameters</span><span class="p">(</span><span class="n">contactmaps</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">clusters</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">clusterAgglomerativeContactMaps</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">contactmaps</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nclusters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processClusterResults</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clusterNum</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">contactMap</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;old:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">clusterNum</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>

            <span class="n">new_contactmaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="p">)</span>
            <span class="n">clusters</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">clusterAgglomerativeContactMaps</span><span class="p">(</span><span class="n">new_contactmaps</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">nclusters</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processClusterResults</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">newClusters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">newClusters</span>
</div>
<div class="viewcode-block" id="ContactMapAgglomerativeClustering.processClusterResults"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ContactMapAgglomerativeClustering.processClusterResults">[docs]</a>    <span class="k">def</span> <span class="nf">processClusterResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Analyse the results obtained from the affinity propagation</span>
<span class="sd">        algorithm.</span>

<span class="sd">        Process [In] String to decide wether it is the results of the first or</span>
<span class="sd">        second clustering</span>
<span class="sd">        clusters [In] Numpy array with the indexes the clusters</span>
<span class="sd">        Labels [In] Numpy array with the cluster each snapshot belongs to&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="n">cluster_members</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s">&quot;first&quot;</span><span class="p">:</span>
                <span class="n">elements_in_cluster</span> <span class="o">=</span> <span class="n">cluster_members</span><span class="o">.</span><span class="n">size</span>
                <span class="c"># contactmapsArray = np.array(self.firstClusteringParams.contactmaps)</span>
                <span class="c"># cluster_index = clusterKmeans(contactmapsArray[cluster_members],1)</span>
                <span class="c"># Instead of using Kmeans to obtain a &quot;center&quot; or representative</span>
                <span class="c"># cluster, select one of the members randomly</span>
                <span class="n">metricsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="n">best_metric_ind</span> <span class="o">=</span> <span class="n">cluster_members</span><span class="p">[</span><span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                <span class="n">best_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">best_metric_ind</span><span class="p">]</span>

                <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">selectRandomCenter</span><span class="p">(</span><span class="n">cluster_members</span><span class="p">,</span>
                                                    <span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">])</span>
                <span class="c"># cluster = Cluster(self.firstClusteringParams.pdb_list[best_metric_ind],</span>
                <span class="c">#                   contactMap=self.firstClusteringParams.contactmaps[best_metric_ind], metric=best_metric)</span>

                <span class="n">contacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">contacts</span><span class="p">[</span><span class="n">cluster_center</span><span class="p">]</span>
                <span class="n">numberOfLigandAtoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">pdb_list</span><span class="p">[</span><span class="n">cluster_center</span><span class="p">]</span><span class="o">.</span><span class="n">getNumberOfAtoms</span><span class="p">()</span>
                <span class="n">contactsPerAtom</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span><span class="o">/</span><span class="n">numberOfLigandAtoms</span>

                <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">pdb_list</span><span class="p">[</span><span class="n">cluster_center</span><span class="p">],</span>
                                  <span class="n">contactMap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="p">[</span><span class="n">cluster_center</span><span class="p">],</span>
                                  <span class="n">contacts</span><span class="o">=</span><span class="n">contactsPerAtom</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">best_metrics</span><span class="p">,</span> <span class="n">metricCol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>

                <span class="n">cluster</span><span class="o">.</span><span class="n">elements</span> <span class="o">+=</span> <span class="n">elements_in_cluster</span><span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;new:</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">contactmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">contactMap</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">newClusters</span><span class="o">.</span><span class="n">addCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">elementsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
                <span class="n">metricsArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="n">elements_in_cluster</span> <span class="o">=</span> <span class="n">elementsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">best_metric_ind</span> <span class="o">=</span> <span class="n">cluster_members</span><span class="p">[</span><span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
                <span class="n">best_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">best_metric_ind</span><span class="p">]</span>
                <span class="c"># contactmapsArray = np.array(self.firstClusteringParams.contactmaps)</span>
                <span class="c"># cluster_index = clusterKmeans(contactmapsArray[cluster_members],1)</span>
                <span class="c"># Instead of using Kmeans to obtain a &quot;center&quot; or representative</span>
                <span class="c"># cluster, select one of the members randomly</span>
                <span class="n">cluster_center</span> <span class="o">=</span> <span class="n">selectRandomCenter</span><span class="p">(</span><span class="n">cluster_members</span><span class="p">,</span>
                                                    <span class="n">metricsArray</span><span class="p">[</span><span class="n">cluster_members</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">])</span>
                <span class="n">cluster_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="n">cluster_center</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cluster_center</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nclusters</span><span class="p">:</span>
                    <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">firstClusteringParams</span><span class="o">.</span><span class="n">newClusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">cluster_index</span><span class="p">]</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">best_metrics</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">elements</span> <span class="o">+=</span> <span class="p">(</span><span class="n">elements_in_cluster</span><span class="o">-</span><span class="n">cluster</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secondClusteringParams</span><span class="o">.</span><span class="n">newClusters</span><span class="o">.</span><span class="n">addCluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ClusteringBuilder"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ClusteringBuilder">[docs]</a><span class="k">class</span> <span class="nc">ClusteringBuilder</span><span class="p">:</span>
<div class="viewcode-block" id="ClusteringBuilder.buildClustering"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.ClusteringBuilder.buildClustering">[docs]</a>    <span class="k">def</span> <span class="nf">buildClustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusteringBlock</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">columnOfReportFile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">paramsBlock</span> <span class="o">=</span> <span class="n">clusteringBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">params</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">ligandResname</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="n">clusteringType</span> <span class="o">=</span> <span class="n">clusteringBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
            <span class="n">contactThresholdDistance</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">contactThresholdDistance</span><span class="p">]</span>
            <span class="n">altSelection</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">alternativeStructure</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">err</span><span class="o">.</span><span class="n">message</span> <span class="o">+=</span> <span class="s">&quot;: Need to provide mandatory parameter in clustering block&quot;</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clusteringType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">contacts</span><span class="p">:</span>
            <span class="n">symmetries</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">symmetries</span><span class="p">,</span> <span class="p">[])</span>

            <span class="n">thresholdCalculatorBuilder</span> <span class="o">=</span> <span class="n">thresholdcalculator</span><span class="o">.</span><span class="n">ThresholdCalculatorBuilder</span><span class="p">()</span>
            <span class="n">thresholdCalculator</span> <span class="o">=</span> <span class="n">thresholdCalculatorBuilder</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">clusteringBlock</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ContactsClustering</span><span class="p">(</span><span class="n">thresholdCalculator</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span>
                                      <span class="n">reportBaseFilename</span><span class="p">,</span> <span class="n">columnOfReportFile</span><span class="p">,</span>
                                      <span class="n">contactThresholdDistance</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">,</span>
                                      <span class="n">altSelection</span><span class="o">=</span><span class="n">altSelection</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clusteringType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">lastSnapshot</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">SequentialLastSnapshotClustering</span><span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="p">,</span>
                                                    <span class="n">columnOfReportFile</span><span class="p">,</span>
                                                    <span class="n">contactThresholdDistance</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clusteringType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">contactMapAffinity</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ContactMapClustering</span><span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="p">,</span>
                                        <span class="n">columnOfReportFile</span><span class="p">,</span>
                                        <span class="n">contactThresholdDistance</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clusteringType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">contactMapAgglomerative</span><span class="p">:</span>
            <span class="n">nclusters</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">nclusters</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ContactMapAgglomerativeClustering</span><span class="p">(</span><span class="n">nclusters</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span>
                                                     <span class="n">reportBaseFilename</span><span class="p">,</span>
                                                     <span class="n">columnOfReportFile</span><span class="p">,</span>
                                                     <span class="n">contactThresholdDistance</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clusteringType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">contactMapAccumulative</span><span class="p">:</span>
            <span class="n">symmetries</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">symmetries</span><span class="p">,[])</span>
            <span class="n">thresholdCalculatorBuilder</span> <span class="o">=</span> <span class="n">thresholdcalculator</span><span class="o">.</span><span class="n">ThresholdCalculatorBuilder</span><span class="p">()</span>
            <span class="n">thresholdCalculator</span> <span class="o">=</span> <span class="n">thresholdCalculatorBuilder</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">clusteringBlock</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">similarityEvaluatorType</span> <span class="o">=</span> <span class="n">paramsBlock</span><span class="p">[</span><span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">similarityEvaluator</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No similarity Evaluator specified!!&quot;</span><span class="p">)</span>
            <span class="n">similarityBuilder</span> <span class="o">=</span> <span class="n">similarityEvaluatorBuilder</span><span class="p">()</span>
            <span class="n">similarityEvaluator</span> <span class="o">=</span> <span class="n">similarityBuilder</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">similarityEvaluatorType</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ContactMapAccumulativeClustering</span><span class="p">(</span><span class="n">thresholdCalculator</span><span class="p">,</span> <span class="n">similarityEvaluator</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span>
                                                    <span class="n">reportBaseFilename</span><span class="p">,</span> <span class="n">columnOfReportFile</span><span class="p">,</span>
                                                    <span class="n">contactThresholdDistance</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">,</span> <span class="n">altSelection</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;Unknown clustering method! Choices are: &quot;</span> <span class="o">+</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">clusteringTypes</span><span class="o">.</span><span class="n">CLUSTERING_TYPE_TO_STRING_DICTIONARY</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

</div></div>
<div class="viewcode-block" id="clusteringResultsParameters"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.clusteringResultsParameters">[docs]</a><span class="k">class</span> <span class="nc">clusteringResultsParameters</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper object to pass parameters in the ContactMap affinity and agglomerative clustering</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[],</span> <span class="n">contactmaps</span><span class="o">=</span><span class="p">[],</span> <span class="n">contacts</span><span class="o">=</span><span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdb_list</span> <span class="o">=</span> <span class="n">pdb_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contactmaps</span> <span class="o">=</span> <span class="n">contactmaps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newClusters</span> <span class="o">=</span> <span class="n">Clusters</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contacts</span> <span class="o">=</span> <span class="n">contacts</span>

</div>
<div class="viewcode-block" id="similarityEvaluatorBuilder"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.similarityEvaluatorBuilder">[docs]</a><span class="k">class</span> <span class="nc">similarityEvaluatorBuilder</span><span class="p">:</span>
<div class="viewcode-block" id="similarityEvaluatorBuilder.build"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.similarityEvaluatorBuilder.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">similarityEvaluatorType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">similarityEvaluatorType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">differenceDistance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">differenceDistanceEvaluator</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">similarityEvaluatorType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">Jaccard</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JaccardEvaluator</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">similarityEvaluatorType</span> <span class="o">==</span> <span class="n">blockNames</span><span class="o">.</span><span class="n">ClusteringTypes</span><span class="o">.</span><span class="n">correlation</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">correlationEvaluator</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;Unknown threshold calculator type! Choices are: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clusteringTypes</span><span class="o">.</span><span class="n">SIMILARITY_TYPES_TO_STRING_DICTIONARY</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

</div></div>
<div class="viewcode-block" id="differenceDistanceEvaluator"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.differenceDistanceEvaluator">[docs]</a><span class="k">class</span> <span class="nc">differenceDistanceEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the similarity of two contactMaps by calculating the ratio of</span>
<span class="sd">        the number of differences over the average of elements in the contacts</span>
<span class="sd">        maps</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="differenceDistanceEvaluator.isSimilarCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.differenceDistanceEvaluator.isSimilarCluster">[docs]</a>    <span class="k">def</span> <span class="nf">isSimilarCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contactMap</span><span class="p">,</span> <span class="n">clusterContactMap</span><span class="p">,</span> <span class="n">symContactMapEvaluator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate if two contactMaps are similar or not, return True if yes,</span>
<span class="sd">            False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">symContactMapEvaluator</span><span class="o">.</span><span class="n">evaluateDifferenceDistance</span><span class="p">(</span><span class="n">contactMap</span><span class="p">,</span> <span class="n">clusterContactMap</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="JaccardEvaluator"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.JaccardEvaluator">[docs]</a><span class="k">class</span> <span class="nc">JaccardEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the similarity of two contactMaps by calculating the Jaccard</span>
<span class="sd">        index, that is, the ratio between the intersection of the two contact</span>
<span class="sd">        maps and their union</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="JaccardEvaluator.isSimilarCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.JaccardEvaluator.isSimilarCluster">[docs]</a>    <span class="k">def</span> <span class="nf">isSimilarCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contactMap</span><span class="p">,</span> <span class="n">clusterContactMap</span><span class="p">,</span> <span class="n">symContactMapEvaluator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate if two contactMaps are similar or not, return True if yes,</span>
<span class="sd">            False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">symContactMapEvaluator</span><span class="o">.</span><span class="n">evaluateJaccard</span><span class="p">(</span><span class="n">contactMap</span><span class="p">,</span> <span class="n">clusterContactMap</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="correlationEvaluator"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.correlationEvaluator">[docs]</a><span class="k">class</span> <span class="nc">correlationEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the similarity of two contact maps by calculating their</span>
<span class="sd">        correlation</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="correlationEvaluator.isSimilarCluster"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.correlationEvaluator.isSimilarCluster">[docs]</a>    <span class="k">def</span> <span class="nf">isSimilarCluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contactMap</span><span class="p">,</span> <span class="n">clusterContactMap</span><span class="p">,</span> <span class="n">symContactMapEvaluator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate if two contactMaps are similar or not, return True if yes,</span>
<span class="sd">            False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">symContactMapEvaluator</span><span class="o">.</span><span class="n">evaluateCorrelation</span><span class="p">(</span><span class="n">contactMap</span><span class="p">,</span> <span class="n">clusterContactMap</span><span class="p">)</span>


<span class="c"># TODO: should it be a class method?</span></div></div>
<div class="viewcode-block" id="clusterContactMaps"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.clusterContactMaps">[docs]</a><span class="k">def</span> <span class="nf">clusterContactMaps</span><span class="p">(</span><span class="n">contactmaps</span><span class="p">,</span> <span class="n">preferences</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cluster multiple contact maps with the affinity propagation algorithm</span>
<span class="sd">        contactmaps [In] Array of contact maps</span>
<span class="sd">        preferences [In] Input value to the affinity propagation algorithm, it</span>
<span class="sd">        affects the number of clusters that will be generated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contactmaps</span> <span class="o">=</span> <span class="n">contactmaps</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">contactmaps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">affinitypropagation</span> <span class="o">=</span> <span class="n">AffinityPropagation</span><span class="p">(</span><span class="n">damping</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                                              <span class="n">preference</span><span class="o">=</span><span class="n">preferences</span><span class="p">,</span>
                                              <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">contactmaps</span><span class="p">)</span>
    <span class="n">cluster_center_indices</span> <span class="o">=</span> <span class="n">affinitypropagation</span><span class="o">.</span><span class="n">cluster_centers_indices_</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">affinitypropagation</span><span class="o">.</span><span class="n">labels_</span>
    <span class="k">return</span> <span class="n">cluster_center_indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="clusterAgglomerativeContactMaps"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.clusterAgglomerativeContactMaps">[docs]</a><span class="k">def</span> <span class="nf">clusterAgglomerativeContactMaps</span><span class="p">(</span><span class="n">contactmaps</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cluster multiple contact maps with the hierarchical clustering algorithm</span>
<span class="sd">        contactmaps [In] Array of contact maps</span>
<span class="sd">        n_clusters [In] Number of clusters that the clustering should generate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contactmaps</span> <span class="o">=</span> <span class="n">contactmaps</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">contactmaps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">agglomerative</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span>
                                            <span class="n">linkage</span><span class="o">=</span><span class="s">&#39;complete&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">contactmaps</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">agglomerative</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">labels</span>

</div>
<div class="viewcode-block" id="clusterKmeans"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.clusterKmeans">[docs]</a><span class="k">def</span> <span class="nf">clusterKmeans</span><span class="p">(</span><span class="n">contactmaps</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cluster  multiple contact maps with the kmeans clustering algorithm</span>
<span class="sd">        contactmaps [In] Array of contact maps</span>
<span class="sd">        n_clusters [In] Number of clusters that the clustering should generate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contactmaps</span> <span class="o">=</span> <span class="n">contactmaps</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">contactmaps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">contactmaps</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">contactmaps</span> <span class="o">-=</span> <span class="n">center</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">contactmaps</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cluster_center</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cluster_center</span>

</div>
<div class="viewcode-block" id="getAllTrajectories"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.getAllTrajectories">[docs]</a><span class="k">def</span> <span class="nf">getAllTrajectories</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all the trajectory files in the paths specified</span>

<span class="sd">        :param paths: The path where to find the trajectories</span>
<span class="sd">        :type paths: str</span>
<span class="sd">        :returns: list -- A list with the names of all th trajectories in paths</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">+=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c"># sort the files obtained by glob by name, so that the results will be the</span>
    <span class="c"># same on all computers</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="selectRandomCenter"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.selectRandomCenter">[docs]</a><span class="k">def</span> <span class="nf">selectRandomCenter</span><span class="p">(</span><span class="n">cluster_members</span><span class="p">,</span> <span class="n">metrics_weights</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a center randomly from a cluster, weighted according to their</span>
<span class="sd">        metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics_weights</span> <span class="o">-=</span> <span class="n">metrics_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">metrics_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">:</span>
        <span class="n">metrics_weights</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">kbT</span> <span class="o">=</span> <span class="mf">0.001987</span><span class="o">*</span><span class="n">T</span>
        <span class="n">metrics_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">metrics_weights</span><span class="o">/</span><span class="n">kbT</span><span class="p">)</span>
        <span class="n">metrics_weights</span> <span class="o">/=</span> <span class="n">metrics_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cluster_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">cluster_members</span><span class="p">,</span>
                                     <span class="n">p</span><span class="o">=</span><span class="n">metrics_weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cluster_index</span>

</div>
<div class="viewcode-block" id="processSnapshots"><a class="viewcode-back" href="../../../AdaptivePELE.clustering.html#AdaptivePELE.clustering.clustering.processSnapshots">[docs]</a><span class="k">def</span> <span class="nf">processSnapshots</span><span class="p">(</span><span class="n">trajectories</span><span class="p">,</span> <span class="n">reportBaseFilename</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span>
                     <span class="n">contactThresholdDistance</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">symmetryEvaluator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create list of pdb, contactMaps, metrics and contacts from a series of</span>
<span class="sd">        snapshots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pdb_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">contactmaps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">contacts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">:</span>
        <span class="n">trajNum</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getTrajNum</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="n">snapshots</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">getSnapshots</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reportBaseFilename</span><span class="p">:</span>
            <span class="n">reportFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">reportBaseFilename</span> <span class="o">%</span> <span class="n">trajNum</span><span class="p">)</span>
            <span class="n">metricstraj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">reportFilename</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metricstraj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">))</span>
        <span class="c"># Prepare data for clustering</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">metricstraj</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">snapshots</span><span class="p">):</span>
            <span class="n">pdb</span> <span class="o">=</span> <span class="n">atomset</span><span class="o">.</span><span class="n">PDB</span><span class="p">()</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">initialise</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">resname</span><span class="p">))</span>
            <span class="n">pdb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdb</span><span class="p">)</span>
            <span class="n">contactMap</span><span class="p">,</span> <span class="n">contactnum</span> <span class="o">=</span> <span class="n">symmetryEvaluator</span><span class="o">.</span><span class="n">createContactMap</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">contactThresholdDistance</span><span class="p">)</span>
            <span class="n">contactmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contactMap</span><span class="p">)</span>
            <span class="n">contacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contactnum</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pdb_list</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">contactmaps</span><span class="p">,</span> <span class="n">contacts</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Daniel Lecina, Joan Francesc Gilabert.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>